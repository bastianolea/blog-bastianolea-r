---
title: Visualiza datos del Censo 2024 en mapas a nivel de manzana con R
author: Basti치n Olea Herrera
date: '2025-12-17'
slug: []
freeze: true
categories:
  - Tutoriales
tags:
  - mapas
  - Chile
  - datos
format:
  hugo-md:
    output-file: index
    output-ext: md
excerpt: "Recientemente lanzaron los datos 2024 del Censo de Poblaci칩n y Vivienda de Chile, incluyendo m치s de 200 variables a nivel de manzana. En este tutorial veremos dos formas de visualizar datos censales a nivel de manzana: con mapas est치ticos en `{ggplot2}`, y con mapas interactivos con `{mapgl}`."
---

Ahora que recientemente lanzaron los datos 2024 del Censo de Poblaci칩n y Vivienda de Chile, me di unos minutos para visualizarlos. En este tutorial veremos dos formas de visualizar datos censales **a nivel de manzana**: con mapas est치ticos en `{ggplot2}`, y con mapas interactivos en `{mapgl}`.


## Datos censales
[Descarga los datos cartogr치ficos del Censo 2024 desde la p치gina del INE](https://censo2024.ine.gob.cl/resultados/), entrando a _Cartograf칤a Censal_ y luego descargando el archivo **Cartograf칤a Pa칤s Censo 2024 (geoparquet)**.

{{< boton "Descargar datos nivel manzana" "https://storage.googleapis.com/bktdescargascenso2024/Cartografia/GEOPARQUET/Cartografia_censo2024_Pais.zip" "fas fa-map-location" >}}


### Cargar cartograf칤as censales
Los datos censales vienen en formato `geoparquet`, que es un formato moderno y eficiente para datos espaciales. 

Podemos cargar datos en `geoparquet` con la funci칩n `read_parquet()` del paquete `{arrow}`.

Si no tenemos `{arrow}` instalado, lo instalamos con `install.packages("arrow")`.

```{r}
#| eval: false
#| message: false
library(arrow)
manzanas <- read_parquet("Cartografia_censo2024_Pais/Cartografia_censo2024_Pais_Manzanas.parquet")
```

```{r}
#| echo: false
#| message: false
library(arrow)

manzanas <- read_parquet("~/Documents/Otros/censo_2024_mapas/datos/Cartografia_censo2024_Pais/Cartografia_censo2024_Pais_Manzanas.parquet")
```

Con la funci칩n `glimpse()` de `{dplyr}` podemos echar un vistazo a las columnas que vienen en la tabla, pero no las mostraremos aqu칤 porque son m치s de 200 游땍

```{r}
#| message: false
#| output: false
library(dplyr)
glimpse(manzanas)
```

Ahora que tenemos los datos, vamos a ver c칩mo visualizarlos en mapas!

{{< aviso "Si necesitas aprender a visualizar mapas con R, [revisa este tutorial de `{sf}`](/blog/mapas_sf/)!" >}}

## Mapas est치ticos

Para generar mapas a partir de cartograf칤a censal, lo que haremos ser치: **filtrar** la base de datos para obtener la unidad territorial que nos interesa, luego **convertir** la cartograf칤a a formato `{sf}`, y finalmente **visualizar** con `{ggplot2}`.

### Preparar datos

Primero filtremos una comuna del pa칤s:

```{r}
# filtrar datos
manzanas_comuna <- manzanas |> 
  filter(COMUNA == "LA FLORIDA")
```

Luego, convertimos a formato `{sf}`, para poder usar en R los pol칤gonos que vienen en la cartograf칤a, especificando un sistema de referencia de coordenadas (CRS) adecuado:

```{r}
#| message: false
library(sf)

# convertir a sf
manzanas_comuna_sf <- manzanas_comuna |> 
  st_as_sf(crs = 4326) 
```

Ahora podemos ver la tabla de datos, que vienen con sus caracter칤sticas espaciales inclu칤das:

```{r}
manzanas_comuna_sf
```

Este **_dataframe_ espacial** posee una columna especial (`SHAPE`) que contiene los pol칤gonos territoriales. 

Cada fila del _dataframe_ corresponde a una unidad territorial, y en la columna `SHAPE` se indica la forma o el pol칤gono que ocupa esa unidad en el territorio.

### Visualizaci칩n

Vamos a generar mapas est치ticos con [`{ggplot2}`, un paquete](/blog/r_introduccion/tutorial_visualizacion_ggplot/) muy poderoso y personalizable para visualizaci칩n de datos.

{{< aviso "Si necesitas aprender a usar `{ggplot2}`, [revisa este tutorial completo de introducci칩n a `{ggplot2}`](/blog/r_introduccion/tutorial_visualizacion_ggplot/)!" >}}

Para visualizar estos datos en `{ggplot2}`, usamos la funci칩n de geometr칤a `geom_sf()`, que est치 dise침ada para trabajar con datos espaciales en formato `{sf}`. Esta funci칩n detecta la columna que contiene los datos espaciales y otras caracter칤sticas espaciales, y permite visualizarlas como mapas.

```{r}
#| message: false
library(ggplot2)

manzanas_comuna_sf |> 
  ggplot() +
  geom_sf() +
  theme_minimal(base_size = 10)
```

Con 칠sto anterior obtenemos el **mapa base**, generado a partir de los pol칤gonos de la columna `SHAPE`. 

Ahora podemos **especificar una variable censal** para visualizar, defini칠ndola en `aes()`. Luego podemos personalizar el gr치fico agregando paletas de colores, ajustes visuales, y textos:

```{r}
#| fig-width: 7
#| fig-height: 6
#| fig-dpi: 220

manzanas_comuna_sf |> 
  ggplot() +
  aes(fill = n_edad_60_mas) +
  geom_sf(color = "white", linewidth = 0.02) +
  scale_fill_fermenter(palette = 13) +
  theme_minimal(base_size = 10) +
  theme(axis.text.x = element_text(angle = 90, vjust = .5)) +
  guides(fill = guide_legend(title = "Poblaci칩n 60 a침os y m치s",
                             position = "top")) +
  labs(title = "Poblaci칩n de 60 a침os y m치s por manzana",
       subtitle = "Comuna de La Florida",
       caption = "Fuente: Censo 2024, INE")
```


### Reutilizar mapa
Podemos repetir todo el proceso, cambiando s칩lo un par de l칤neas, para obtener el **mapa de otra variable en una comuna distinta**:

```{r}
#| fig-width: 6
#| fig-height: 6
#| fig-dpi: 220

manzanas |> 
  # filtrar
  filter(COMUNA == "PUENTE ALTO") |> # comuna
  # convertir
  st_as_sf(crs = 4326) |> 
  # graficar
  ggplot() +
  aes(fill = n_discapacidad) + # variable
  geom_sf(color = "white", linewidth = 0.02) +
  scale_fill_fermenter(palette = 11) +
  theme_minimal(base_size = 10) +
  theme(axis.text.x = element_text(angle = 90, vjust = .5)) +
  guides(fill = guide_legend(title = "Poblaci칩n 60 a침os y m치s",
                             position = "top")) +
  labs(title = "Poblaci칩n con discapacidad por manzana",
       subtitle = "Comuna de Puente Alto",
       caption = "Fuente: Censo 2024, INE")
```

Lo bueno de disponer del c칩digo es que podemos [**automatizar la creaci칩n de mapas** para distintas comunas o regiones](/blog/ggplot_purrr/), simplemente cambiando los filtros y las variables que queremos graficar, o podemos cambiar el nivel territorial cargando uno de los otros archivos, o bien, [realizando una operaci칩n de resumen](https://bastianolea.rbind.io/blog/r_introduccion/dplyr_summarize/) sobre los datos.

### Mapa por comunas

Solamente como prueba, filtremos una regi칩n del pa칤s, luego agrupemos por comunas, y sumemos la poblaci칩n de una de las variables en cada comuna con `summarize()` para **pasar desde un mapa por manzanas a un mapa por comunas**:

```{r}
#| message: false
sf_use_s2(FALSE)

comunas <- manzanas |> 
  # filtrar
  filter(REGION == "METROPOLITANA DE SANTIAGO") |> 
  # convertir
  st_as_sf(crs = 4326) |> 
  # resumir por comuna
  group_by(COMUNA) |> 
  summarize(n_ocupado = sum(n_ocupado), # sumar datos por grupo
            SHAPE = st_union(SHAPE)) # unir pol칤gonos por grupo
```

Obtenemos como resultado una tabla de datos por comuna:

```{r}
comunas
```

Ahora podemos visualizar un mapa de la **poblaci칩n ocupada por comuna** en la Regi칩n Metropolitana:

```{r}
#| fig-width: 6
#| fig-height: 6.5
#| fig-dpi: 220
#| message: false

comunas |> 
  ggplot() +
  aes(fill = n_ocupado) + # variable
  geom_sf(color = "white", linewidth = 0.01) +
  colorspace::scale_fill_continuous_sequential(palette = "Sunset", na.value = "white",
                                               labels = scales::label_number(big.mark = "."),
                                               breaks = c(0, 50000, 100000, 150000, 200000, 250000)) +
  theme_minimal(base_size = 10) +
  theme(axis.text.x = element_text(angle = 90, vjust = .5),
        legend.key.width = unit(3, "mm")) +
  guides(fill = guide_colorbar(title = "Ocupados/as", position = "right")) +
  coord_sf(xlim = c(-70.83, -70.47), 
           ylim = c(-33.3, -33.68)) +
  labs(title = "Poblaci칩n ocupada",
       subtitle = "Regi칩n Metropolitana",
       caption = "Fuente: Censo 2024, INE")
```


{{< info "Para m치s informaci칩n sobre visualizaci칩n de mapas de Chile comunales y regionales, revisa [este tutorial](/blog/tutorial_mapa_chile/) sobre mapas b치sicos de Chile, o [este tutorial](/blog/tutorial_mapa_chile_subdere/) para usar cartograf칤as oficiales." >}}

----


## Mapas interactivos

Para visualizar **mapas interactivos** en R existen varias opciones, como [el paquete `{leaflet}`](https://rstudio.github.io/leaflet/), pero yo quer칤a usar [el paquete `{mapgl}`](https://walker-data.com/mapgl/), desarrollado por [Kyle Walker](https://walker-data.com) que permite crear mapas interactivos usando [MapLibre](https://maplibre.org), una biblioteca de c칩digo abierto para mapas web.

Este paquete se caracteriza por el acceso que ofrece a usuarixs de R a mapas online interactivos de alta calidad y alto rendimiento.

Primero instalamos [`{mapgl}`](https://walker-data.com/mapgl/):
```{r}
#| eval: false
install.packages("mapgl")
```

Luego lo cargamos:
```{r}
#| message: false
library(mapgl)
```

Y probamos su funcionamiento con un **mapa vac칤o** (prueba haciendo zoom o navegando el mapa con el cursor)

```{r}
maplibre(center = c(-71.5, -33.0), 
         zoom = 3)
```

Ahora usemos `{mapgl}` con los datos censales. Podemos **repetir el proceso** de filtrado de la comuna o regi칩n que nos interese:

```{r}
# filtrar y seleccionar
manzanas_comuna <- manzanas |> 
  filter(COMUNA == "VALPARA칈SO") |> 
  select(REGION, n_edad_60_mas, SHAPE)
```

Luego hacemos la misma conversi칩n a `{sf}` para trabajar mejor con datos espaciales:

```{r}
# convertir a sf
manzanas_comuna_sf <- manzanas_comuna |> 
  st_as_sf(crs = 4326)
```

Finalmente podemos **visualizar los datos en un mapa interactivo** con la funci칩n `maplibre_view()`, especificando la variable que queremos graficar en el mapa:

```{r}
manzanas_comuna_sf |> 
  maplibre_view(column = "n_edad_60_mas")
```

춰As칤 de simple! 游눞

Lo interesante es que `{mapgl}` tambi칠n permite hacer cosas [mucho m치s incre칤bles](https://walker-data.com/mapgl/articles/layers-overview.html) usando [Mapbox](https://www.mapbox.com/), una plataforma de mapas de primer nivel que tiene muchas m치s opciones de personalizaci칩n y estilos de mapas, incluyendo figuras tridimensionales, edificios, efectos visuales y m치s.

{{< cafecito >}}

{{< cursos >}}

