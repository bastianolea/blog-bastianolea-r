{
  "hash": "c483ce09fa43386e3fcf74fb3b526b2e",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Tutorial: Mapa en {ggplot2} con calles desde Open Street Map en R\"\nauthor: \"Bastián Olea Herrera\"\ndate: 2024-09-03\ncategories: ['Tutoriales']\ntags: ['mapas', 'Chile']\nformat: hugo-md\nlang: es\nfreeze: true\nlinks:\n- icon: github\n  icon_pack: fab\n  name: código\n  url: https://github.com/bastianolea/tutorial_r_mapa_openstreetmap\n---\n\n{{< indice >}}\n\n\n\n\nEn este tutorial crearemos un mapa de una región de Chile, y sobre el polígono geográfico aplicaremos otros elementos geográficos como calles, avenidas y carreteras, obtenidos desde Open Street Map (proveedor de mapas online abierto y comunitario). \n\nEsto puede servir para crear visualizaciones de datos espaciales minimalistas que de todos modos entreguen elementos urbanos de referencia para que les usuaries puedan ubicarse mejor espacialmente.\n\nUsaremos `{dplyr}` para manipular los datos, el paquete `{ggplot2}` para visualización de datos, `{sf}` para tratamiento de elementos espaciales, `{rnaturalearth}` para obtener mapas de cualquier país o región del mundo, y `{osmdata}` para obtener datos estaciales desde Open Street Map (OSM) por medio de su API pública.\n\n\n### Cargar paquetes\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(dplyr) #manipulación de datos\nlibrary(ggplot2) #gráficos\nlibrary(sf) #elementos espaciales\nlibrary(rnaturalearth) #mapas del mundo\nlibrary(osmdata) #datos open street map\n```\n:::\n\n\n\n## Obtener mapa de país y de región\n\nEl primer paso es obtener un mapa de Chile, a nivel de regiones, usando la función `ne_states()` del paquete `{rnaturalearth}`. Luego filtramos el dataframe resultante para enfocarnos en una sola región del país.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# obtener mapa pero a nivel de regiones\nmapa_1 <- rnaturalearth::ne_states(country = \"Chile\") |> \n    select(name, name_es, iso_3166_2, code_hasc, geometry)\n\nmapa_2 <- mapa_1 |> \n    filter(name == \"Los Lagos\")\n\nmapa_2\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSimple feature collection with 1 feature and 4 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: -74.40722 ymin: -44.045 xmax: -71.65926 ymax: -40.27304\nGeodetic CRS:  WGS 84\n       name   name_es iso_3166_2 code_hasc                       geometry\n1 Los Lagos Los Lagos      CL-LL     CL.LG MULTIPOLYGON (((-71.76926 -...\n```\n\n\n:::\n:::\n\n\n\nPrevisualizamos la región obtenida usando `{ggplot2}`:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmapa_2 |> \n    ggplot() +\n    geom_sf(linewidth = .4,\n            color = \"grey80\", fill = \"grey95\") +\n    theme_classic()\n```\n\n::: {.cell-output-display}\n![](index.markdown_strict_files/figure-markdown_strict/unnamed-chunk-3-1.png){width=768}\n:::\n:::\n\n\n\nLuego realizamos el primer paso para obtener los datos desde Open Street Map, que es definir las coordenadas de la caja delimitadora o _bounding box_ del lugar del que vamos a solicitar datos. Por ejemplo, una ciudad específica. Si bien esto se puede hacer con la función `osmdata::getbb()`, los resultados no siempre coinciden con lo que esperamos (la región o ciudad puede salir más recortada de lo esperado), por lo que preferimos usar directamente la caja del mapa que queremos visualizar, usando `sf::st_bbox()`.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# obtener perímetro o área abarcada por el mapa\ncaja <- mapa_2 |> st_bbox()\n\n# opcionalmente, se podría hacer con el nombre del lugar\n# area <- getbb(\"Región de Los Lagos, Chile\")\n\ncaja\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n     xmin      ymin      xmax      ymax \n-74.40722 -44.04500 -71.65926 -40.27304 \n```\n\n\n:::\n:::\n\n\n\n## Obtener datos geográficos desde Open Street Map\n\nTeniendo estas coordenadas, se solicitan los datos haciendo un _query_ a la API _Overpass_ de OSM. En esta solicitud se especifica la característica del mapa que se va a obtener, y sus valores; en este caso, queremos obtener las calles de una región, por lo que la _feature_ corresponde a _highway._ Dividimos la query en varias partes, para tener en objetos separados las calles de distintos tamaños (a grandes rasgos: autopistas y avenidas, calles secundarias, y calles interiores).\n\nConsiderar que cada query puede tomar un tiempo, dependiendo de la cantidad de datos, y que OSM es un proyecto soportado por voluntarios, por lo que se recomienda no abusar de la API (hacer la mínima cantidad de solicitudes, no hacer muchas solicitudes seguidas, etc.)\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# obtener calles dentro de la caja\ncalles_grandes <- caja |> \n    opq(timeout = 500) |> \n    add_osm_feature(key = \"highway\", \n                    value = c(\"motorway\", \"primary\", \"motorway_link\", \"primary_link\")) |> \n    osmdata_sf()\n\ncalles_medianas <- caja |> \n    opq(timeout = 500) |> \n    add_osm_feature(key = \"highway\", \n                    value = c(\"secondary\", \"tertiary\", \"secondary_link\", \"tertiary_link\")) |> \n    osmdata_sf()\n\ncalles_chicas <- caja |>\n    opq(timeout = 500) |>\n    add_osm_feature(key = \"highway\",\n                    value = c(\"residential\", \"living_street\")) |>\n    osmdata_sf()\n```\n:::\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ncalles_grandes\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nObject of class 'osmdata' with:\n                 $bbox : -44.0449981164699,-74.4072159499999,-40.2730445289999,-71.6592646899999\n        $overpass_call : The call submitted to the overpass API\n                 $meta : metadata including timestamp and version numbers\n           $osm_points : 'sf' Simple Features Collection with 29125 points\n            $osm_lines : 'sf' Simple Features Collection with 3270 linestrings\n         $osm_polygons : 'sf' Simple Features Collection with 0 polygons\n       $osm_multilines : NULL\n    $osm_multipolygons : NULL\n```\n\n\n:::\n:::\n\n\n\nHabiendo obtenido los datos geográficos desde OSM, recibimos objetos que contienen los elementos espaciales. Extraemos las líneas de cada uno de los objetos, para quedarnos sólo con las calles. Opcionalmente, podemos recortar los elementos espaciales obtenidos con la figura del mapa, usando el mapa como figura de recorte para que las líneas de las calles no se salgan de los márgenes del mapa.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# extraer toda la geometría\ncalles_grandes_a <- calles_grandes$osm_lines\ncalles_medianas_a <- calles_medianas$osm_lines\ncalles_chicas_a <- calles_chicas$osm_lines\n\n# recortar geometría para que calce dentro del polígono del mapa\ncalles_grandes_b <- st_intersection(calles_grandes$osm_lines, mapa_2)\ncalles_medianas_b <- st_intersection(calles_medianas$osm_lines, mapa_2)\ncalles_chicas_b <- st_intersection(calles_chicas$osm_lines, mapa_2)\n```\n:::\n\n\n\n## Visualizar mapa con calles\n\nFinalmente, podemos aplicar las capas obtenidas a nuestro gráfico de `{ggplot2}`. Podemos ajustar la apariencia de cada tipo de calle por separado dado que las ubicamos en capas distintas.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n    ggplot() +\n    # capa del país entero (como fondo)\n    geom_sf(data = mapa_1, \n            linewidth = .4,\n            color = \"grey95\", fill = \"grey98\") +\n    # capa del mapa de la región\n    geom_sf(data = mapa_2,\n            linewidth = .4, \n            color = \"grey80\", fill = \"grey95\") +\n    # capas osm\n    geom_sf(data = calles_medianas_b, \n            linewidth = .3, alpha = .3) +\n    geom_sf(data = calles_grandes_b, \n            linewidth = .4, alpha = .3) +\n    # recortar vista\n    coord_sf(xlim = caja[c(1, 3)],\n             ylim = c(-42.4, -40.3)) +\n    theme_classic()\n```\n\n::: {.cell-output-display}\n![](index.markdown_strict_files/figure-markdown_strict/unnamed-chunk-10-1.png){width=768}\n:::\n:::\n\n\n\nOtro ejemplo del mapa visto desde más cerca, incluyendo la capa de calles interiores:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n    # capa del mapa\n    geom_sf(data = mapa_2,\n            fill = \"grey95\") +\n    # capas osm\n    geom_sf(data = calles_grandes_b, \n            linewidth = .3, alpha = 1) +\n    geom_sf(data = calles_medianas_b, \n            linewidth = .3, alpha = .4) +\n    geom_sf(data = calles_chicas_b, \n            linewidth = .2, alpha = .2) +\n    # recortar vista\n    coord_sf(xlim = c(-73.18, -73.09),\n             ylim = c(-40.6, -40.55)) +\n    theme_classic()\n```\n\n::: {.cell-output-display}\n![](index.markdown_strict_files/figure-markdown_strict/unnamed-chunk-11-1.png){width=768}\n:::\n:::\n\n{{< cafecito >}}\n",
    "supporting": [
      "index.markdown_strict_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": null,
    "postProcess": false
  }
}