{
  "hash": "55c2b5b800b03f6d6a99127075b01537",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Usar un modelo de lenguaje local (LLM) para analizar texto en R\"\nauthor: Bastián Olea Herrera\nformat: hugo-md\ndate: 2024-10-29\ncategories:\n  - Análisis de texto\ntags:\n  - análisis de texto\n  - inteligencia artificial\nlang: es\ncache: false\nfreeze: true\nexcerpt: Procesa datos con IA en R, localmente! El paquete `{mall}` permite aplicar un modelo de lenguaje (LLM) local a tus datos, para así crear nuevas columnas a partir de prompts, tales como resumir, extraer sentimiento, clasificación, y más.\n---\n\n[Recientemente se lanzó el paquete `{mall}`,](https://mlverse.github.io/mall/) que facilita el uso de un LLM _(large language model)_ o modelo de lenguaje de gran tamaño para analizar texto con IA en un dataframe. Esto significa que, para cualquier dataframe que tengamos, podemos aplicar un modelo de IA a una de sus columnas y recibir sus resultados en una columna nueva.\n\nPara poder hacer ésto, primero necitamos tener un modelo LLM instalado localmente en nuestra computadora. Para eso, [tenemos que instalar Ollama](https://ollama.com), y ejecutar la aplicación. Ollama tiene que estar abierto para poder proveer del modelo a nuestra sesión de R.\n\nLuego, [instalamos el paquete `{ollamar}` en R,](https://hauselin.github.io/ollama-r/), que es una dependencia de `{mall}`. Usamos `{ollamar}` para descargar a nuestro equipo el modelo de lenguaje que usaremos:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ollamar)\nollamar::pull(\"llama3.2:3b\")\n```\n:::\n\n\nCon eso hecho, ya puedes usar modelo directamente desde R con `{ollamar}`, o en un dataframe usando `{mall}`.\n\n\n\n::: {.cell messages='false'}\n\n```{.r .cell-code}\nlibrary(mall)\nlibrary(dplyr)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\nAttaching package: 'dplyr'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following objects are masked from 'package:stats':\n\n    filter, lag\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following objects are masked from 'package:base':\n\n    intersect, setdiff, setequal, union\n```\n\n\n:::\n\n```{.r .cell-code}\nmall::llm_use(\"ollama\", \"llama3.2:3b\")\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n── mall session object \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nBackend: ollama\nLLM session: model:llama3.2:3b\nR session:\ncache_folder:/var/folders/gt/vdp_nx_x3bq5wgnlr1nphkd1zbdps_/T//RtmpzqBMog/_mall_cachee7f20d2b28\n```\n\n\n:::\n:::\n\n\nCon el siguiente código vamos a descargar un dataframe que contiene texto de noticias de Chile, para usarlo como datos de prueba. Los datos provienen de mi [repositorio de web scraping y análisis de prensa de Chile.](https://github.com/bastianolea?tab=repositories)\n\n\n::: {.cell messages='false'}\n\n```{.r .cell-code}\n# obtener datos de prensa\nurl <- \"https://raw.githubusercontent.com/bastianolea/prensa_chile/refs/heads/main/prensa_datos_muestra.csv\"\n\ndatos_prensa <- readr::read_csv2(url, show_col_types = FALSE)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nℹ Using \"','\" as decimal and \"'.'\" as grouping mark. Use `read_delim()` for more control.\n```\n\n\n:::\n\n```{.r .cell-code}\nhead(datos_prensa)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 4\n  titulo                                                cuerpo fuente fecha     \n  <chr>                                                 <chr>  <chr>  <date>    \n1 Hombre de 66 años fue asesinado en plena vía pública… \"El h… Coope… 2024-07-21\n2 Revive el cuarto capítulo de Indecisos: Candidatos a… \"Este… Megan… 2024-09-03\n3 Menos personas circulando y miedo de los residentes:… \"Poca… Megan… 2024-04-08\n4 CEO de Walmart Chile sostiene que si la empresa no d… \"Hace… The C… 2024-12-22\n5 Pdte. Boric entregó mensaje por la muerte de Piñera … \"El p… CNN C… 2024-02-06\n6 Encuentran dos cadáveres en un canal de regadío en P… \"Pers… Publi… 2024-07-13\n```\n\n\n:::\n:::\n\n\nProbemos `{mall}` con 10 noticias al azar, pidiéndole al LLM que detecte el sentimiento de cada texto (si es positivo, neutro o negativo):\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# extraer sentimiento de textos\ndatos_sentimiento <- datos_prensa |> \n  select(titulo) |> \n  slice(10:20) |> \n  llm_sentiment(titulo, \n                pred_name = \"sentimiento\",\n                options = c(\"positivo\", \"neutro\", \"negativo\"))\n\ndatos_sentimiento |> \n  relocate(sentimiento, .before = titulo)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 11 × 2\n   sentimiento titulo                                                           \n   <chr>       <chr>                                                            \n 1 negativo    \"Dos personas resultan baleadas tras intentar evitar asalto en m…\n 2 negativo    \"Mujer de 54 años recibió trasplante de bomba cardíaca y riñón d…\n 3 negativo    \"Fiscalía investiga una segunda presunta agresión de Monsalve co…\n 4 negativo    \"Los RUT definitivos que reciben el premio de La Suerte en Chile…\n 5 negativo    \"Este domingo parte el Festival de Viña 2024: Revisa el orden y …\n 6 negativo    \"Danesa se coronó como Miss Universo 2024: Emilia Dides quedó en…\n 7 positivo    \"Hassler opta por tesis de Boric por sobre la del PC en Venezuel…\n 8 negativo    \"Carabinero de civil disparó a delincuente que estaba robando en…\n 9 negativo    \"Seguridad en días del 18’: Ex PDI llama a ser precavido y a evi…\n10 positivo    \"¿Quién es Janet Yellen? La Secretaria del Tesoro de EEEUU que v…\n11 negativo    \"Fijan audiencia para los detenidos por el homicidio del subofic…\n```\n\n\n:::\n:::\n\n\nOtro uso es pedirle que genere resúmenes de textos. Para ello, usaremos un _prompt_ manual, donde le pedimos explícitamente `\"resumir en hasta 5 palabras\"`. El paquete aplicará dicha solicitud a cada una de las observaciones en la columna indicada, y retornará los resultados en una nueva columna llamada `resumen`:\n\n\n::: {.cell messages='false'}\n\n```{.r .cell-code}\n# resumir textos\ndatos_resumidos <- datos_prensa |> \n  select(titulo, cuerpo) |> \n  slice_sample(n = 10) |> \n  mutate(resumen = llm_vec_custom(\n    cuerpo, \n    \"resumir en hasta 7 palabras\")) |> \n  select(resumen, titulo)\n\ndatos_resumidos\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 10 × 2\n   resumen                                     titulo                           \n   <chr>                                       <chr>                            \n 1 Lo siento, no tengo información disponible. Sernageomin decreta Alerta Amari…\n 2 Lo siento, no tengo información disponible. Caos y golpes durante llegada de…\n 3 Lo siento, no tengo información disponible. Delegada Martínez y evacuaciones…\n 4 Lo siento, no tengo información disponible. Incendio en Copenhague destruye …\n 5 Lo siento, no tengo información disponible. VIDEO| “No entienden que…”: Jorg…\n 6 Lo siento, no tengo información disponible. Alza en los planes podría genera…\n 7 Lo siento, no tengo información disponible. Exmilitar venezolano presuntamen…\n 8 Lo siento, no tengo información disponible. ¿Hay que adelantar o retrasar el…\n 9 Lo siento, no tengo información disponible. Familia Imschenetzky compra part…\n10 Lo siento, no tengo información disponible. Feria de vinos llega a Providenc…\n```\n\n\n:::\n:::\n\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": null,
    "postProcess": false
  }
}