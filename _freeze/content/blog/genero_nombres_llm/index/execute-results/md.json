{
  "hash": "eee6d7988580300ae7554f7d5505c248",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: Predecir género a partir de nombres usando un modelo de lenguaje en R\nauthor: Bastián Olea Herrera\ndate: '2025-02-19'\nslug: []\ncategories: []\ntags:\n  - procesamiento de datos\n  - inteligencia artificial\n  - análisis de texto\nexecute: \n  freeze: true\nexcerpt: Aprende a usar modelos extensos de lenguaje (LLM) para clasificar datos con un caso de uso real, donde se necesita asumir el género de las personas a partir de sus nombres para poder realizar análisis con perspectiva de género. Aplicar inteligencia artificial en R para este tipo de tareas es puede ahorrarte muchísimo tiempo, y dependiendo de como ajustes los datos y el _prompt_ puede entregar buenos resultados.\n\n---\n\n\n\n\n[Hace poco](https://bastianolea.rbind.io/blog/introduccion_llm_mall/) conocí [el paquete `{mall}`](https://mlverse.github.io/mall/), que facilita mucho el uso de un un modelo de lenguaje (LLM) local como una herramienta cotidiana para el análisis y procesamiento de datos. \n\nEl paquete incluye varias funciones para usar un modelo LLM local en las columnas de un dataframe. `{mall}` te puede ayudar a :\n- clasificar el contenido de una variable\n- resumir textos\n- extraer sentimiento a partir del texto\n- extraer información desde el texto\n- confirmar si algo es verdadero o falso a partir de un texto\n- y también a aplicar cualquier _prompt_ a una variable.\n\nRecientemente lo usé para un caso real, donde tenía una columna de casi 2.000 nombres, y necesitaba asignarle un género a cada una de estas personas, solamente a partir de sus nombres y apellidos. \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(dplyr) # manipulación de datos\nlibrary(readr) # cargar datos\nlibrary(tictoc) # medición de tiempo\nlibrary(mall) # aplicar modelos de lenguaje en dataframe\n```\n:::\n\n\n\n\n[Los datos provienen del servicio electoral de Chile](https://github.com/bastianolea/servel_scraping_votaciones), y los nombres corresponden a 1.576 candidatos y candidatas a alcaldías.\n\nCon el siguiente código puedes descargar los datos listos para su uso:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\narchivo_remoto <- \"https://raw.githubusercontent.com/bastianolea/servel_scraping_votaciones/refs/heads/main/datos/resultados_alcaldes_2024.csv\"\n\ncandidatos <- readr::read_csv2(archivo_remoto) |> \n  select(nombres = candidato, partido, sector) |> \n  filter(nombres != \"Nulo/Blanco\")\n\ncandidatos\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1,576 × 3\n   nombres                            partido sector       \n   <chr>                              <chr>   <chr>        \n 1 Marco Antonio Gonzalez Candia      RN      Derecha      \n 2 Veronica Maricel Cueto Cueto       IND     Independiente\n 3 Marcela Maritza Mansilla Potocnjak IND     Independiente\n 4 Alejandro Felipe Ricotti Sepulveda IND     Independiente\n 5 Carlos Orlando Tapia Aviles        IND     Independiente\n 6 Maria Luisa Hamilton Velasco       IND     Independiente\n 7 Gaston Dubournais Riveros          IND     Independiente\n 8 Marcela Chamorro Macias            IND     Izquierda    \n 9 Jose Andres Arellano Blanco        IND     Independiente\n10 Andrea Elizabeth Galvez Sepulveda  REP     Derecha      \n# ℹ 1,566 more rows\n```\n\n\n:::\n:::\n\n\n\n\nEn esta instancia, tengo configurado `{ollamar}` para que use el modelo local y de código abierto [Llama 3.2](https://www.llama.com), de 3 billones de parámetros. Podemos instalar este modelo, o uno distinto, con estas instrucciones:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ollamar)\nollamar::pull(\"llama3.2\") # descargar e instalar un modelo\nmall::llm_use(\"ollama\", \"llama3.2\") # elegir un modelo instalado\n```\n:::\n\n\n\n\n\nEn una primera prueba, le entregamos al modelo de lenguaje la columna `nombres` (que contiene nombre, segundo nombre, apellido, y segundo apellido), y le pedimos al modelo que clasifique cada observación como _masculino_ o _femenino._\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntic()\nresultados_1 <- candidatos |> \n  llm_classify(nombres,\n               labels = c(\"masculino\", \"femenino\"),\n               pred_name = \"genero\")\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nOllama local server running\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n── mall session object \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nBackend: Ollama\nLLM session: model:llama3.2:latest\nR session:\ncache_folder:/var/folders/z8/61w5pwts4h5fsvhfqs1wpvk40000gn/T//RtmpntMvSc/_mall_cache127421f0326aa\n```\n\n\n:::\n\n```{.r .cell-code}\ntoc()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n421.687 sec elapsed\n```\n\n\n:::\n:::\n\n\n\n\nEl proceso tarda aproximadamente 7 minutos en clasificar los casi 1.576 nombres, un ritmo de 0.26 segundos por cada predicción.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nresultados_1 |> select(genero, nombres) |> slice_sample(n = 15)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 15 × 2\n   genero    nombres                            \n   <chr>     <chr>                              \n 1 masculino Andres Parra Sandoval              \n 2 femenino  Leontina Del Carmen Gutierrez Rivas\n 3 masculino Mario Ortiz Cabezas                \n 4 masculino Jose Esteban Alarcon Vargas        \n 5 femenino  Nancy Milena Alfaro Jurjevic       \n 6 masculino Osvaldo Herrera Valdes             \n 7 femenino  Ninoska Villegas Lamas             \n 8 masculino Juan Carlos Diaz Avendaño          \n 9 masculino German Pino Maturana               \n10 masculino Gonzalo Rubio Fuenzalida           \n11 femenino  Laura Correa Fuentes               \n12 masculino Alex Fernando Castillo Blas        \n13 masculino Jonathan Velasquez Ramirez         \n14 masculino Jorge Espinoza Cuevas              \n15 femenino  Elizabeth Marican Rivas            \n```\n\n\n:::\n:::\n\n\n\n\nPara la segunda prueba, intentamos entregarle al modelo *solamente los nombres*, excluyendo segundos nombres y apellidos, bajo el supuesto de que el primer nombre es el mejor predictor del género, mientras que los apellidos no son un predictor del género.\n\nProbamos el código con una [expresión regular](https://stringr.tidyverse.org/articles/regular-expressions.html) (regex) para extraer la primera palabra de una secuencia de texto:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncandidatos |> \n  mutate(nombre = stringr::str_extract(nombres, \"\\\\w+\")) |> \n  select(nombre, nombres) |> \n  slice_sample(n = 5)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 5 × 2\n  nombre    nombres                          \n  <chr>     <chr>                            \n1 Paola     Paola Romero Valdivia            \n2 Alejandra Alejandra Villegas Huichaman     \n3 Yuliana   Yuliana Ema Bustos Zapata        \n4 Elizabeth Elizabeth Salinas Valle          \n5 Freddy    Freddy Antonio Ramirez Villalobos\n```\n\n\n:::\n:::\n\n\n\n\nRealizamos la segunda prueba de clasificación, esta vez solamente con el primer nombre:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntic()\nresultados_2 <- candidatos |> \n  mutate(nombre = stringr::str_extract(nombres, \"\\\\w+\")) |> # extraer nombres\n  llm_classify(nombre,\n               labels = c(\"masculino\", \"femenino\"),\n               pred_name = \"genero\")\ntoc()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n139.47 sec elapsed\n```\n\n\n:::\n:::\n\n\n\n\nEsta vez el proceso tarda aproximadamente 2 minutos, ¡casi 4 veces más rápido! El modelo clasifica los textos más rápido mientras menos texto tenga que analizar. Es importante mencionar que la velocidad va a depender mucho de tu computador, específicamente su GPU.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nresultados_2 |> select(genero, nombre) |> slice_sample(n = 10)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 10 × 2\n   genero    nombre  \n   <chr>     <chr>   \n 1 masculino Pablo   \n 2 masculino Luis    \n 3 femenino  Sandra  \n 4 masculino Johnny  \n 5 masculino Miguel  \n 6 masculino Oscar   \n 7 masculino Luis    \n 8 masculino Gonzalo \n 9 masculino Juan    \n10 masculino Mauricio\n```\n\n\n:::\n:::\n\n\n\n\nRevisemos los resultados, obteniendo una muestra al azar de 30 nombres:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nresultados_2 |> \n  filter(nombres != \"Nulo/Blanco\") |> \n  relocate(genero, nombre, .before = nombres) |> \n  slice_sample(n = 30) |> \n  print(n = Inf)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 30 × 5\n   genero    nombre    nombres                             partido  sector      \n   <chr>     <chr>     <chr>                               <chr>    <chr>       \n 1 masculino Christian Christian Arturo Cardenas Silva     IND      Independien…\n 2 masculino Osvaldo   Osvaldo Cartagena Garcia            IND      Independien…\n 3 masculino Romelio   Romelio Borquez Hidalgo             IND      Derecha     \n 4 masculino Patricio  Patricio Marchant Ulloa             IND      Centro      \n 5 masculino Claudio   Claudio Miranda Ibañez              IND      Independien…\n 6 masculino Marcos    Marcos Gaete Flores                 IND      Derecha     \n 7 masculino Raul      Raul Jaime Espejo Escobar           IND      Independien…\n 8 masculino Camilo    Camilo Alejandro Rapu Riroroko      IND      Centro      \n 9 femenino  Clara     Clara Lazcano Fernández             IND      Derecha     \n10 masculino Drazen    Drazen Andre Markusovic Caceres     PDG      Derecha     \n11 femenino  Denisse   Denisse Tamara Leon Rojas           REP      Derecha     \n12 masculino Juan      Juan Pablo Gomez Ramirez            IND      Independien…\n13 masculino Alexis    Alexis Mendez Uribe                 IND      Independien…\n14 femenino  Juana     Juana Sarmiento Acosta              IND      Independien…\n15 masculino Marco     Marco Antonio Gonzalez Candia       RN       Derecha     \n16 masculino Miguel    Miguel Bruna Silva                  IND      Independien…\n17 masculino Hernaldo  Hernaldo Andres Ahumada Chavez      IND      Independien…\n18 femenino  Nivia     Nivia Del Carmen Riquelme Gutierrez IGUALDAD Izquierda   \n19 masculino Cristian  Cristian Alejandro Sobarzo Sanhueza IND      Independien…\n20 masculino Cristian  Cristian Andres Pozo Parraguez      PS       Izquierda   \n21 femenino  Rosa      Rosa Torres Escobedo                IND      Independien…\n22 masculino Juan      Juan Carlos Gonzalez Romo           IND      Independien…\n23 femenino  Paula     Paula Rodriguez Valenzuela          IND      Independien…\n24 masculino Gabriel   Gabriel Silva Gonzalez              IND      Independien…\n25 femenino  Daniela   Daniela Isabel Munizaga Villegas    REP      Derecha     \n26 masculino Ramon     Ramon Sandoval Zurita               IND      Independien…\n27 masculino Ramon     Ramon Bahamonde Cea                 IND      Independien…\n28 masculino Claudio   Claudio Arellano Cortes             IND      Independien…\n29 femenino  Sigrid    Sigrid Ramirez Arias                IND      Derecha     \n30 masculino Patricio  Patricio Ernesto Gonzalez Nuñez     IND      Independien…\n```\n\n\n:::\n:::\n\n\n\nRevisando los nombres, al parecer las predicciones son bastante buenas, pero al hacer más pruebas nos damos cuenta de que no es 100% infalible, ya que se equivoca en algunos nombres como _Aracelli, Edita, Elizabeth,_ o _Josselyn._ si se requiere aumentar la calidad de la predicción, podría [instalarse un modelo de lenguaje más grande.](https://ollama.com/library)\n\n\nOtra alternativa para mejorar el desempeño de la clasificación (es decir, que sea más certer) es agregarle al _prompt_ más contexto sobre lo que se busca obtener, así como una alternativa para que el modelo clasifique términos que no sabe dónde clasificar:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nresultados_3 <- candidatos |> \n  mutate(nombre = stringr::str_extract(nombres, \"\\\\w+\")) |> # extraer nombres\n  llm_classify(nombre,\n               labels = c(\"masculino\", \"femenino\", \"desconocido\"),\n               pred_name = \"genero\", \n               additional_prompt = \"obtener el género desde nombres de personas\")\n```\n:::\n\n\n\n\nEn el argumento `additional_prompt` podemos especifiacr una instrucción extra para el modelo, lo que a veces es suficiente para que el modelo tenga contexto extra para poder clasificar correctamente. En mi experiencia, esto mejora considerablemente la calidad de las respuestas, y reduce la incertidumbre en algunos casos.\n\nEn conclusión, se trata de una herramienta muy fácil de implementar, que también es capaz de ahorrarnos bastante tiempo, por ejemplo, en el desarrollo de un algoritmo que detecte el nombre a partir de ciertas estructuras en la composición de cada uno, o bien, en tener que contrastar los nombres con alguna base de datos ya existente de nombres con un género asignado (si es que existe).\n\n\n\n\n{{< cafecito >}}\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": null,
    "postProcess": false
  }
}