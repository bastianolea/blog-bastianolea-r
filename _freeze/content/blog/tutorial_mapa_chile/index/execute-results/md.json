{
  "hash": "5213be75b68b2ae552d10e6f8870e940",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: Crea un mapa de Chile y visualiza datos comunales y regionales con mapas en R\nauthor: Basti√°n Olea Herrera\ndate: '2024-11-25'\ndraft: false\nfreeze: true\nformat: hugo-md\nslug: []\ncategories:\n  - tutoriales\ntags:\n  - mapas\n  - gr√°ficos\n  - ciencias sociales\n  - Chile\neditor_options: \n  chunk_output_type: inline\nexecute: \n  warning: false\n  message: false\nexcerpt: Visualizar datos geogr√°ficamente es una herramienta de comunicaci√≥n y an√°lisis de datos muy potente. En este tutorial te explico c√≥mo obtener mapas comunales y regionales de Chile en R, y c√≥mo crear un gr√°ficos que visualizan variables num√©ricas en las comunas y regiones del pa√≠s. En pocos pasos puedes transformar tus datos territoriales en visualizaciones mucho m√°s densas e informativas.\nlinks:\n  - icon: github\n    icon_pack: fab\n    name: c√≥digo\n    url: https://gist.github.com/bastianolea/df03203e88534261ef831f2cb4fca254\n---\n\n{{< indice >}}\n\nVisualizar datos geogr√°ficamente es una herramienta de comunicaci√≥n y an√°lisis de datos muy potente. En este tutorial te explico c√≥mo obtener mapas comunales y regionales de Chile en R, y c√≥mo crear un gr√°ficos que visualizan variables num√©ricas en las comunas y regiones del pa√≠s. En pocos pasos puedes transformar tus datos territoriales en visualizaciones mucho m√°s densas e informativas.\n\nPara crear mapas sencillos, donde una variable num√©rica se visualice en cada unidad territorial por medio de una escala de colores, solamente se necesitan dos cosas: la informaci√≥n geogr√°fica que te permite visualizar el mapa en s√≠ mismo, y los datos que podamos corresponder con las unidades territoriales del mapa.\n\nEn este breve tutorial veremos c√≥mo obtener los mapas, como unir los datos al mapa, y c√≥mo generar visualizaciones de estos mapas en R.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(chilemapas) # mapas de chile\nlibrary(dplyr) # manipulaci√≥n de datos\nlibrary(ggplot2) # visualizaci√≥n de datos\nlibrary(scales) # utilidad para visualizaci√≥n de datos\nlibrary(sf) # manipulaci√≥n de datos geogr√°ficos\n```\n:::\n\n\n## Mapa de Chile por comunas\n\nEl paquete [`{chilemapas}`](https://pacha.dev/chilemapas/), desarrollado por [Mauricio Vargas](https://pacha.dev), ofrece una colecci√≥n de mapas terrestres de Chile con topolog√≠a simplificada. Simplemente llamando el objeto `mapa_comunas` obtenemos un dataframe con la informaci√≥n geogr√°fica de cada comuna del pa√≠s.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmapa_comunas <- chilemapas::mapa_comunas\n\nmapa_comunas\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 345 √ó 4\n   codigo_comuna codigo_provincia codigo_region                         geometry\n   <chr>         <chr>            <chr>                       <MULTIPOLYGON [¬∞]>\n 1 01401         014              01            (((-68.86081 -21.28512, -68.921‚Ä¶\n 2 01403         014              01            (((-68.65113 -19.77188, -68.811‚Ä¶\n 3 01405         014              01            (((-68.65113 -19.77188, -68.635‚Ä¶\n 4 01402         014              01            (((-69.31789 -19.13651, -69.271‚Ä¶\n 5 01404         014              01            (((-69.39615 -19.06125, -69.400‚Ä¶\n 6 01107         011              01            (((-70.1095 -20.35131, -70.1243‚Ä¶\n 7 01101         011              01            (((-70.09894 -20.08504, -70.102‚Ä¶\n 8 02104         021              02            (((-68.98863 -25.38016, -68.987‚Ä¶\n 9 02101         021              02            (((-70.60654 -23.43054, -70.601‚Ä¶\n10 02201         022              02            (((-67.94302 -22.38175, -67.955‚Ä¶\n# ‚Ñπ 335 more rows\n```\n\n\n:::\n:::\n\n\nEn este dataframe, la columna `geometry` representa los pol√≠gonos de cada comuna. Esta informaci√≥n ya es suficiente para visualizar el mapa con R usando `{ggplot2}` y [`{sf}`, un paquete para trabajar con datos espaciales](https://r-spatial.github.io/sf/).\n\nPara visualizar el mapa, primero usamos `sf::st_set_geometry()` para asignar la geometr√≠a al dataframe. De este modo, le indicamos a R que estos datos deben graficarse en un mapa con determinadas coordenadas e informaci√≥n sobre proyecci√≥n.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngrafico_comunas <- mapa_comunas |> \n  st_set_geometry(mapa_comunas$geometry) |> # asignar geometr√≠a\n  ggplot() + # gr√°fico\n  geom_sf() # capa geom√©trica\n\ngrafico_comunas +\n  theme_classic()\n```\n\n::: {.cell-output-display}\n![](index.markdown_strict_files/figure-markdown_strict/unnamed-chunk-3-1.png){width=768}\n:::\n:::\n\n\nDado que Chile tiene islas muy alejadas del territorio continental, como Rapa Nui o Juan Fern√°ndez, el mapa queda con mucho espacio en blanco. Podemos recortar las coordenadas de la longitud del mapa (el eje _x_ del gr√°fico) para que el mapa solamente abarque Chile continental: \n\n\n::: {.cell}\n\n```{.r .cell-code}\ngrafico_comunas + \n  coord_sf(xlim = c(-77, -65)) +\n  theme_classic()\n```\n\n::: {.cell-output-display}\n![](index.markdown_strict_files/figure-markdown_strict/unnamed-chunk-4-1.png){width=288}\n:::\n:::\n\n\n## Mapa regional de Chile\n\nPara generar un mapa de regiones, debemos crear las regiones. Esto no es complicado si pensamos que, en el fondo, las regiones son simplemente la uni√≥n de las comunas que las componen. El paquete `{sf}` simplifica much√≠simo el trabajo con datos geogr√°ficos, en este caso la uni√≥n de distintos pol√≠gonos en uno solo.\n\nAgrupamos las filas del dataframe por la variable `codigo_region`, para que todas las comunas que pertenecen a la misma regi√≥n est√©n agrupadas, y usamos `summarize()` junto a la funci√≥n `sf::st_union()` para que los pol√≠gonos de las comunas dentro de cada regi√≥n se combinen, obteniendo pol√≠gonos regionales:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmapa_regiones <- mapa_comunas |> \n  group_by(codigo_region) |> \n  summarize(geometry = st_union(geometry)) # resumir los datos agrupados uni√©ndolos\n\nmapa_regiones\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 16 √ó 2\n   codigo_region                                                        geometry\n   <chr>                                                          <GEOMETRY [¬∞]>\n 1 01            POLYGON ((-69.93023 -21.4246, -69.92376 -21.42622, -69.91932 -‚Ä¶\n 2 02            MULTIPOLYGON (((-68.0676 -24.32856, -67.91698 -24.26902, -67.8‚Ä¶\n 3 03            MULTIPOLYGON (((-71.58497 -29.02456, -71.58844 -29.02838, -71.‚Ä¶\n 4 04            MULTIPOLYGON (((-70.54551 -31.30742, -70.53877 -31.30074, -70.‚Ä¶\n 5 05            MULTIPOLYGON (((-71.33832 -33.45237, -71.33763 -33.44836, -71.‚Ä¶\n 6 06            POLYGON ((-71.5477 -34.87458, -71.54211 -34.87581, -71.53566 -‚Ä¶\n 7 07            POLYGON ((-70.41724 -35.63022, -70.41108 -35.6302, -70.40146 -‚Ä¶\n 8 08            MULTIPOLYGON (((-73.53466 -36.97378, -73.53245 -36.97829, -73.‚Ä¶\n 9 09            MULTIPOLYGON (((-73.35306 -38.73343, -73.35396 -38.72799, -73.‚Ä¶\n10 10            MULTIPOLYGON (((-73.1691 -41.87755, -73.16135 -41.87781, -73.1‚Ä¶\n11 11            MULTIPOLYGON (((-75.41754 -48.73857, -75.43249 -48.74372, -75.‚Ä¶\n12 12            MULTIPOLYGON (((-70.35563 -52.94478, -70.34688 -52.93971, -70.‚Ä¶\n13 13            POLYGON ((-70.47405 -33.8624, -70.47327 -33.86269, -70.46068 -‚Ä¶\n14 14            MULTIPOLYGON (((-73.39503 -39.88698, -73.39672 -39.89339, -73.‚Ä¶\n15 15            POLYGON ((-69.07223 -19.02723, -69.06394 -19.02607, -69.04748 ‚Ä¶\n16 16            POLYGON ((-72.38553 -36.91169, -72.37685 -36.91617, -72.37034 ‚Ä¶\n```\n\n\n:::\n:::\n\n\nObtenemos un dataframe con una fila por regi√≥n, dado que las comunas fueron unidas en pol√≠gonos regionales. La columna `geometry` ahora contiene la uni√≥n de las comunas que hicimos con la funci√≥n `st_union()`. Podemos visualizar este nuevo dataframe regional usando `{ggplot2}` y `{sf}`, igual que en el paso anterior:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngrafico_regiones <- mapa_regiones |> \n  st_set_geometry(mapa_regiones$geometry) |> # especificar la geometr√≠a del mapa\n  ggplot() + # graficar\n  geom_sf() + # capa geogr√°fica\n  coord_sf(xlim = c(-77, -65)) # recortar coordenadas\n\ngrafico_regiones +\n  theme_classic()\n```\n\n::: {.cell-output-display}\n![](index.markdown_strict_files/figure-markdown_strict/unnamed-chunk-6-1.png){width=288}\n:::\n:::\n\n\nAhora que tenemos nuestros mapas por comunas y por regiones, la idea es poder utilizarlos para visualizar datos en ellos.\n\n## Visualizar datos en el mapa\n\nPara visualizar los datos en un mapa, aplicaremos colores a los distintos pol√≠gonos de nuestro mapa, ya sean comunas o regiones. La intensidad del color, o su posici√≥n dentro de la escala de color elegida, representar√° el valor de la variable num√©rica que queremos visualizar.\n\nLa idea de fondo para entender la visualizaci√≥n de datos geogr√°ficos por pol√≠gonos es entender que los mapas que obtuvimos contienen en cada fila un pol√≠gono (la informaci√≥n geogr√°fica para dibujar la comuna o regi√≥n), y adem√°s, en cada fila contienen informaci√≥n que identifica al pol√≠gono correspondiente. En nuestro caso, la informaci√≥n de los pol√≠gonos corresponde al _c√≥digo √∫nico territorial_ de las comunas, y el c√≥digo de regiones en el caso de las regiones. √âstos son c√≥digos num√©ricos que identifican cada unidad territorial del pa√≠s.\n\nLa idea es poder agregarle datos a nuestro mapa, de manera que las filas que representan unidades territoriales tengan tambi√©n columnas con datos sobre dichas unidades territoriales.\n\nEntonces, deber√≠amos tener nuestro dataframe con el mapa, y otro dataframe donde tengamos los datos que queremos adjuntar al mapa. Si tenemos un mapa de comunas, tenemos que tener los datos por comuna que queremos agregarle al mapa. \n\n### Datos comunales\n\n#### Obtener datos por web scraping\nPara visualizar un mapa de datos comunales, primero obtendremos datos comunales desde Wikipedia. Usamos el paquete para hacer un web scraping y obtener una [tabla de datos de las comunas del pa√≠s.](https://es.wikipedia.org/wiki/Anexo:Comunas_de_Chile)\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(rvest)\n\n# direcci√≥n de wikipedia con tabla de comunas de Chile\nurl <- \"https://es.wikipedia.org/wiki/Anexo:Comunas_de_Chile\"\n\n# obtener tabla con datos de comunas con web scraping\ntabla <- session(url) |> \n  read_html() |> \n  html_table(convert = FALSE)\n\ntabla[[1]]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 346 √ó 12\n   CUT (C√≥digo √önico Territori‚Ä¶¬π Nombre ``    Provincia Regi√≥n `Superficie(km¬≤)`\n   <chr>                         <chr>  <chr> <chr>     <chr>  <chr>            \n 1 15101                         Arica  \"\"    Arica     Arica‚Ä¶ 4.799,4          \n 2 15102                         Camar‚Ä¶ \"\"    Arica     Arica‚Ä¶ 3.927            \n 3 15201                         Putre  \"\"    Parinaco‚Ä¶ Arica‚Ä¶ 5.902,5          \n 4 15202                         Gener‚Ä¶ \"\"    Parinaco‚Ä¶ Arica‚Ä¶ 2.244,4          \n 5 01101                         Iquiq‚Ä¶ \"\"    Iquique   Tarap‚Ä¶ 2.242,1          \n 6 01107                         Alto ‚Ä¶ \"\"    Iquique   Tarap‚Ä¶ 572.9            \n 7 01401                         Pozo ‚Ä¶ \"\"    Tamarugal Tarap‚Ä¶ 13.765,8         \n 8 01402                         Cami√±a \"\"    Tamarugal Tarap‚Ä¶ 2.200,2          \n 9 01403                         Colch‚Ä¶ \"\"    Tamarugal Tarap‚Ä¶ 4.015,6          \n10 01404                         Huara  \"\"    Tamarugal Tarap‚Ä¶ 10.474,6         \n# ‚Ñπ 336 more rows\n# ‚Ñπ abbreviated name: ¬π‚Äã`CUT (C√≥digo √önico Territorial)`\n# ‚Ñπ 6 more variables: Poblaci√≥n2020 <chr>, `Densidad(hab./km¬≤)` <chr>,\n#   `IDH 2005` <chr>, `IDH 2005` <chr>, Latitud <chr>, Longitud <chr>\n```\n\n\n:::\n:::\n\nLuego obtener los datos, realizamos una peque√±a limpieza. Limpiamos los nombres de las variables, seleccionamos las variables que nos interesan, y luego las convertimos apropiadamente a valores num√©ricos, donde tenemos que eliminar los separadores de miles, y transformar los separadores de decimales a puntos.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(janitor)\nlibrary(stringr)\n\n# limpiar datos\ndatos_comunas <- tabla[[1]] |> \n  clean_names() |> \n  # seleccionar y renombrar columnas\n  select(codigo_comuna = cut_codigo_unico_territorial,\n         nombre, region, superficie_km2,\n         poblacion = poblacion2020) |> \n  # eliminar espacios de la columna de poblaci√≥n\n  mutate(poblacion = str_remove_all(poblacion, \" \"),\n         poblacion = as.numeric(poblacion)) |> \n  # eliminar los separadores de miles\n  mutate(superficie_km2 = str_remove_all(superficie_km2, \"\\\\.\"),\n         # convertir comas a puntos\n         superficie_km2 = str_replace(superficie_km2, \",\", \".\"),\n         superficie_km2 = as.numeric(superficie_km2))\n\ndatos_comunas\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 346 √ó 5\n   codigo_comuna nombre        region             superficie_km2 poblacion\n   <chr>         <chr>         <chr>                       <dbl>     <dbl>\n 1 15101         Arica         Arica y Parinacota          4799.    247552\n 2 15102         Camarones     Arica y Parinacota          3927       1233\n 3 15201         Putre         Arica y Parinacota          5902.      2515\n 4 15202         General Lagos Arica y Parinacota          2244.       810\n 5 01101         Iquique       Tarapac√°                    2242.    223463\n 6 01107         Alto Hospicio Tarapac√°                    5729     129999\n 7 01401         Pozo Almonte  Tarapac√°                   13766.     17395\n 8 01402         Cami√±a        Tarapac√°                    2200.      1375\n 9 01403         Colchane      Tarapac√°                    4016.      1583\n10 01404         Huara         Tarapac√°                   10475.      3000\n# ‚Ñπ 336 more rows\n```\n\n\n:::\n:::\n\n\nAhora que tenemos una tabla de datos que contiene la columna `codigo_comuna` con el c√≥digo √∫nico territorial de las comunas, podemos unirla al mapa de comunas.\n\n\n\n#### Agregar datos a los mapas\nEsta operaci√≥n de unir dos tablas de datos diferentes, pero que coinciden en una columna en com√∫n, se realiza [con la funci√≥n `left_join()`](/blog/left_join/). El principio de `left_join()` es que tenemos dos tablas de datos, y ambas tablas de datos tienen una misma columna, que poseen los mismos valores (en nuestro caso, una columna con las comunas o los c√≥digos √∫nicos territoriales de las comunas). Entonces, ambas tablas se van a unir seg√∫n la correspondencias de estas columnas en com√∫n.\n\n_Ejemplo:_\n\n::: {.cell}\n\n```{.r .cell-code}\ntabla_a <- tribble(~animal,   ~favorito, \n                   \"gato\",    \"pescado\", \n                   \"mapache\", \"basura\",\n                   \"perro\",   \"carne\")\n\ntabla_b <- tribble(~animal,   ~belleza, ~inteligencia, ~carisma,\n                   \"gato\",    8,        6,             5,\n                   \"perro\",   5,        2,             8,\n                   \"mapache\", 10,       7,             2)\n\nleft_join(tabla_a, \n          tabla_b, \n          by = \"animal\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 3 √ó 5\n  animal  favorito belleza inteligencia carisma\n  <chr>   <chr>      <dbl>        <dbl>   <dbl>\n1 gato    pescado        8            6       5\n2 mapache basura        10            7       2\n3 perro   carne          5            2       8\n```\n\n\n:::\n:::\n\nEn el ejemplo, tenemos dos tablas, donde las dos tienen una misma columna con los mismos datos, y otras columnas con datos distintos. Usando `left_join()` podemos unir ambas tablas de datos a partir de la columna que tienen en com√∫n. Como resultado obtenemos una nueva tabla que tiene todas las columnas.\n\n----\n\nProcedemos a unir los datos con el mapa usando `left_join()`, especificando en el argumento `by` que la uni√≥n sea a partir de la columna `codigo_comuna`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmapa_comunas_2 <- mapa_comunas |> \n  # adjuntar datos al mapa, coincidiendo por columna de c√≥digo de comunas\n  left_join(datos_comunas,\n            by = join_by(codigo_comuna)) |> \n  relocate(geometry, .after = 0) # tirar geometr√≠a al final\n\nmapa_comunas_2\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 345 √ó 8\n   codigo_comuna codigo_provincia codigo_region nombre     region superficie_km2\n   <chr>         <chr>            <chr>         <chr>      <chr>           <dbl>\n 1 01401         014              01            Pozo Almo‚Ä¶ Tarap‚Ä¶         13766.\n 2 01403         014              01            Colchane   Tarap‚Ä¶          4016.\n 3 01405         014              01            Pica       Tarap‚Ä¶          8934.\n 4 01402         014              01            Cami√±a     Tarap‚Ä¶          2200.\n 5 01404         014              01            Huara      Tarap‚Ä¶         10475.\n 6 01107         011              01            Alto Hosp‚Ä¶ Tarap‚Ä¶          5729 \n 7 01101         011              01            Iquique    Tarap‚Ä¶          2242.\n 8 02104         021              02            Taltal     Antof‚Ä¶         20405.\n 9 02101         021              02            Antofagas‚Ä¶ Antof‚Ä¶         30718.\n10 02201         022              02            Calama     Antof‚Ä¶         15597.\n# ‚Ñπ 335 more rows\n# ‚Ñπ 2 more variables: poblacion <dbl>, geometry <MULTIPOLYGON [¬∞]>\n```\n\n\n:::\n:::\n\n\nComo resultado, tenemos un nuevo dataframe que adem√°s de tener los datos geogr√°ficos de las comunas, tambi√©n tiene nuevas columnas con datos que podemos visualizar.\n\n#### Visualizar datos comunales\n\nPara visualizar datos comunales en un mapa, especificamos la columna de geometr√≠a que contiene la informaci√≥n geogr√°fica, y creamos un gr√°fico de `{ggplot2}`. En este gr√°fico, especificamos que el relleno de los pol√≠gonos (`fill`) se haga a partir de una de las variables num√©ricas. \n\nUsamos la funci√≥n `geom_sf()` para agregar una capa de geometr√≠a a nuestro gr√°fico que contenga los pol√≠gonos territoriales de las comunas. Luego, definimos un tema, una paleta de colores, y corregimos la escala del eje horizontal. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nmapa_comunas_2 |> \n  st_set_geometry(mapa_comunas_2$geometry) |> # asignar geometr√≠a\n  ggplot() + # gr√°fico\n  aes(fill = poblacion) +\n  geom_sf(linewidth = 0) + # capa geom√©trica\n  theme_classic() +\n  scale_fill_distiller(type = \"seq\", palette = 12, \n                       labels = label_comma(big.mark = \".\")) + # colores\n  scale_x_continuous(breaks = seq(-76, -65, length.out = 3) |> floor()) + # escala x\n  coord_sf(xlim = c(-77, -65)) + # recortar coordenadas\n  theme(legend.key.width = unit(3, \"mm\"))\n```\n\n::: {.cell-output-display}\n![](index.markdown_strict_files/figure-markdown_strict/unnamed-chunk-11-1.png){width=288}\n:::\n:::\n\nComo resultado obtenemos un mapa coropl√©tico, o mapa de coropletas, que es un mapa donde cada regi√≥n o pol√≠gono est√° relleno de un color que representa un valor en una escala de una variable.\n\nAc√° hacemos otro mapa, usando el mismo c√≥digo y simplemente cambiando la variable de relleno de los pol√≠gonos territoriales:\n\n::: {.cell}\n\n```{.r .cell-code}\nmapa_comunas_2 |> \n  st_set_geometry(mapa_comunas_2$geometry) |>\n  ggplot() +\n  aes(fill = superficie_km2) + # variable de relleno\n  geom_sf(linewidth = 0) +\n  theme_classic() +\n  scale_fill_distiller(type = \"seq\", palette = 11,\n                       labels = label_comma(big.mark = \".\")) + \n  scale_x_continuous(breaks = seq(-76, -65, length.out = 3) |> floor()) +\n  coord_sf(xlim = c(-77, -65)) + \n  theme(legend.key.width = unit(3, \"mm\"))\n```\n\n::: {.cell-output-display}\n![](index.markdown_strict_files/figure-markdown_strict/unnamed-chunk-12-1.png){width=288}\n:::\n:::\n\n\n#### Mapa de una sola regi√≥n, por comunas\n\nSi queremos visualizar una sola regi√≥n del pa√≠s, subdividida por comunas, tan sencillo como agregar un filtro a los datos que filtre las filas que pertenecen a la regi√≥n que nos interesa. En este caso, vamos a visualizar la poblaci√≥n por comunas de la regi√≥n del Libertador General Bernardo O'Higgins:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# filtrar datos\nmapa_comunas_filtro <- mapa_comunas_2 |> \n  filter(codigo_region == \"06\")\n\n# mapa\nmapa_comunas_filtro |> \n  st_set_geometry(mapa_comunas_filtro$geometry) |>\n  ggplot() +\n  aes(fill = poblacion) +\n  geom_sf(linewidth = 0.12, color = \"white\") +\n  geom_sf_text(aes(label = comma(poblacion, big.mark = \".\")), \n               size = 2, color = \"white\", check_overlap = T) +\n  theme_classic() +\n  scale_fill_distiller(type = \"seq\", palette = 12,\n                       labels = label_comma(big.mark = \".\")) + \n  theme(legend.key.width = unit(3, \"mm\")) +\n  theme(axis.title = element_blank())\n```\n\n::: {.cell-output-display}\n![](index.markdown_strict_files/figure-markdown_strict/unnamed-chunk-13-1.png){width=576}\n:::\n:::\n\n\nEn este caso, agregamos tambi√©n la funci√≥n `geom_sf_text()` para agregar una capa nuestro gr√°fico que contiene las cifras para cada comuna. Hay que tener en consideraci√≥n que poner n√∫meros o textos sobre mapas suele ser complejo, porque el mapa ya es denso visualmente, y agregarle texto puede hacer que se vuelva ilegible. Hay que tener especial cuidado en resolver situaciones como textos que pasan por encima de bordes en el mapa, que se ubican incorrectamente dentro de los pol√≠gonos, o que se sobreponen uno sobre otros debido a que los pol√≠gonos se ven muy peque√±os dentro del mapa.\n\n----\n\n### Datos regionales\n\n#### Obtener datos por web scraping\n\nPara hacer el ejemplo de visualizar datos a nivel regional, nuevamente obtendremos datos a esta escala usando web scraping. Obtendremos una tabla del Producto Interno Bruto regional desde el [sitio web de el Banco Central de Chile.](https://si3.bcentral.cl/Siete/ES/Siete/Cuadro/CAP_CCNN/MN_CCNN76/CCNN2018_PIB_REGIONAL_N/637899740344107786)\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(rvest)\n\n# direcci√≥n del sitio del banco central\nurl <- \"https://si3.bcentral.cl/Siete/ES/Siete/Cuadro/CAP_CCNN/MN_CCNN76/CCNN2018_PIB_REGIONAL_N/637899740344107786\"\n\n# obtener tabla con datos de comunas con web scraping\ntabla_pib <- session(url) |> \n  read_html() |> \n  html_table(convert = FALSE)\n```\n:::\n\nLimpiamos los datos seleccionando las columnas que necesitamos, transformando la columna a tipo num√©rico, y filtrando las filas para quedar solamente con las que corresponden a las regiones de Chile:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndatos_regiones <- tabla_pib [[1]] |> \n  janitor::clean_names() |> \n  select(region = serie, pib = x2023) |> \n  mutate(pib = str_remove_all(pib, \"\\\\.\"),\n         pib = as.numeric(pib)) |> \n  filter(str_detect(region, \"Regi√≥n\"))\n\ndatos_regiones\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 16 √ó 2\n   region                                                 pib\n   <chr>                                                <dbl>\n 1 Regi√≥n de Arica y Parinacota                          2169\n 2 Regi√≥n de Tarapac√°                                    7892\n 3 Regi√≥n de Antofagasta                                31290\n 4 Regi√≥n de Atacama                                     6004\n 5 Regi√≥n de Coquimbo                                    9174\n 6 Regi√≥n de Valpara√≠so                                 20275\n 7 Regi√≥n Metropolitana de Santiago                    109143\n 8 Regi√≥n del Libertador General Bernardo OHiggins      11910\n 9 Regi√≥n del Maule                                     10348\n10 Regi√≥n de √ëuble                                       4106\n11 Regi√≥n del Biob√≠o                                    16731\n12 Regi√≥n de La Araucan√≠a                                7743\n13 Regi√≥n de Los R√≠os                                    3561\n14 Regi√≥n de Los Lagos                                   9432\n15 Regi√≥n de Ays√©n del General Carlos Ib√°√±ez del Campo   1573\n16 Regi√≥n de Magallanes y de la Ant√°rtica Chilena        2490\n```\n\n\n:::\n:::\n\n\n#### Crear columna de c√≥digos regionales\n\nLos datos que obtuvimos no contienen una variable con el c√≥digo √∫nico territorial de las regiones, dado que es un dato que est√° en desuso desde la promulgaci√≥n de una ley en 2018 que proh√≠be el uso de los n√∫meros en comunicaciones p√∫blicas. Sin embargo, en muchas base de datos oficiales se sigue usando la numeraci√≥n de las regiones, principalmente para evitar problemas de diferencias en los nombres de las regiones, por ejemplo, si contienen o no las palabras _Regi√≥n de_ o _Regi√≥n del_ para cada regi√≥n, si contienen tildes o no, si contienen abreviaciones o no, si contienen s√≠mbolos como _e√±es_ o ap√≥strofes, etc. Todos estos problemas son resueltos por el uso de identificador num√©rico de las regiones.\n\nComo el mapa que obtuvimos con el paquete `{chilemapas}` utiliza el c√≥digo regional, en el dato frente de nuestros datos crearemos una columna con los mismos c√≥digos regionales, asignados a cada regi√≥n a partir de la coincidencia con los textos. Por ejemplo, si el texto del nombre de la regi√≥n contiene la palabra _Arica_, se le asigna el c√≥digo `15`. Esta forma de asignar los c√≥digos regionales puede ser inexacta, pero es muy sencillo confirmar si es que la asignaci√≥n de c√≥digos funciona correctamente, y tambi√©n siempre es posible utilizar [expresiones regulares en `{stringr}`](https://stringr.tidyverse.org/articles/regular-expressions.html) para hacer coincidencias m√°s flexibles, como por ejemplo, coincidir una palabra con un c√≥digo sin importar si la palabra tiene o no tilde, o est√° mal escrita.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndatos_regiones_2 <- datos_regiones |> \n  mutate(codigo_region = case_when(\n    str_detect(region, \"Arica\") ~ 15,\n    str_detect(region, \"Tarapac√°\") ~ 1,\n    str_detect(region, \"Antofagasta\") ~ 2,\n    str_detect(region, \"Atacama\") ~ 3,\n    str_detect(region, \"Coquimbo\") ~ 4,\n    str_detect(region, \"Valpara√≠so\") ~ 5,\n    str_detect(region, \"Metropolitana\") ~ 13,\n    str_detect(region, \"Libertador General\") ~ 6,\n    str_detect(region, \"Maule\") ~ 7,\n    str_detect(region, \"√ëuble\") ~ 16,\n    str_detect(region, \"Biob√≠o\") ~ 8,\n    str_detect(region, \"Araucan√≠a\") ~ 9,\n    str_detect(region, \"Los R√≠os\") ~ 14,\n    str_detect(region, \"Los Lagos\") ~ 10,\n    str_detect(region, \"Ays√©n\") ~ 11,\n    str_detect(region, \"Magallanes\") ~ 12\n  )) |> \n  rename(nombre_region = region)\n```\n:::\n\n\n#### Unir datos con mapa\n\nLuego de crear la variable de c√≥digos regionales, podemos hacer la uni√≥n entre ambas tablas de datos, mapas y datos regionales, usando `left_join()`:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmapa_regiones_2 <- mapa_regiones |> \n  mutate(codigo_region = as.numeric(codigo_region)) |> \n  left_join(datos_regiones_2,\n            by = join_by(codigo_region)) |> \n  relocate(geometry, .after = 0) # tirar columna al final\n\nmapa_regiones_2\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 16 √ó 4\n   codigo_region nombre_region                     pib                  geometry\n           <dbl> <chr>                           <dbl>            <GEOMETRY [¬∞]>\n 1             1 Regi√≥n de Tarapac√°               7892 POLYGON ((-69.93023 -21.‚Ä¶\n 2             2 Regi√≥n de Antofagasta           31290 MULTIPOLYGON (((-68.0676‚Ä¶\n 3             3 Regi√≥n de Atacama                6004 MULTIPOLYGON (((-71.5849‚Ä¶\n 4             4 Regi√≥n de Coquimbo               9174 MULTIPOLYGON (((-70.5455‚Ä¶\n 5             5 Regi√≥n de Valpara√≠so            20275 MULTIPOLYGON (((-71.3383‚Ä¶\n 6             6 Regi√≥n del Libertador General‚Ä¶  11910 POLYGON ((-71.5477 -34.8‚Ä¶\n 7             7 Regi√≥n del Maule                10348 POLYGON ((-70.41724 -35.‚Ä¶\n 8             8 Regi√≥n del Biob√≠o               16731 MULTIPOLYGON (((-73.5346‚Ä¶\n 9             9 Regi√≥n de La Araucan√≠a           7743 MULTIPOLYGON (((-73.3530‚Ä¶\n10            10 Regi√≥n de Los Lagos              9432 MULTIPOLYGON (((-73.1691‚Ä¶\n11            11 Regi√≥n de Ays√©n del General C‚Ä¶   1573 MULTIPOLYGON (((-75.4175‚Ä¶\n12            12 Regi√≥n de Magallanes y de la ‚Ä¶   2490 MULTIPOLYGON (((-70.3556‚Ä¶\n13            13 Regi√≥n Metropolitana de Santi‚Ä¶ 109143 POLYGON ((-70.47405 -33.‚Ä¶\n14            14 Regi√≥n de Los R√≠os               3561 MULTIPOLYGON (((-73.3950‚Ä¶\n15            15 Regi√≥n de Arica y Parinacota     2169 POLYGON ((-69.07223 -19.‚Ä¶\n16            16 Regi√≥n de √ëuble                  4106 POLYGON ((-72.38553 -36.‚Ä¶\n```\n\n\n:::\n:::\n\n\n#### Visualizar datos regionales\nFinalmente, visualizamos los datos en un mapa regional de la misma forma que lo hicimos con los mapas comunales. Esta vez, el mapa y los datos vienen en una fila por regi√≥n, con la variable `geometry` que conteniendo la geometr√≠a del pol√≠gono regional. Por tanto, el c√≥digo es exactamente el mismo, y solamente cambia el dataframe que usamos para generar el gr√°fico:\n  \n\n::: {.cell}\n\n```{.r .cell-code}\nmapa_regiones_2 |> \n  st_set_geometry(mapa_regiones_2$geometry) |> # asignar geometr√≠a\n  ggplot() + # gr√°fico\n  aes(fill = pib) +\n  geom_sf(linewidth = 0.12, color = \"white\") + # capa geom√©trica\n  theme_classic() +\n  scale_fill_distiller(type = \"seq\", palette = 18,\n                       labels = label_comma(big.mark = \".\")) +\n  scale_x_continuous(breaks = seq(-76, -65, length.out = 3) |> floor()) +\n  coord_sf(expand = F, xlim = c(-77, -65)) + # recortar coordenadas\n  theme(legend.key.width = unit(3, \"mm\"))\n```\n\n::: {.cell-output-display}\n![](index.markdown_strict_files/figure-markdown_strict/unnamed-chunk-18-1.png){width=288}\n:::\n:::\n\n\n----\n\nVisualizar datos geogr√°ficamente es una herramienta de comunicaci√≥n y an√°lisis de datos muy potente. Personalmente, encuentro que el potencial de la visualizaci√≥n de datos en mapas radica mucho m√°s all√° de simplemente mapear una variable a un territorio, sino a **incentivar que el p√∫blico analice el mapa en relaci√≥n a todo el conjunto de conocimientos que tenemos sobre del espacio que habitamos, sus caracter√≠sticas sociales, y las desigualdades distribuidas en el territorio.** \n\n----\n\nSi este tutorial te sirvi√≥, por favor considera hacerme una peque√±a donaci√≥n para poder tomarme un cafecito mientras escribo el siguiente tutorial ü•∫\n\n{{< cafecito >}}",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": null,
    "postProcess": false
  }
}